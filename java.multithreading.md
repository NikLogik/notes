---
id: 50z2yq611v1vsouzfwjnq2m
title: "Multithreading"
desc: ""
updated: 1684337280459
created: 1668290905678
---

Создание потоков

1. Наследний от класса Thread
2. Реализовать интерфейс Runnable

## Негативные явления

### Race condition

Возникает когда два или более потоков работают с общими данными и каждый из них пытается изменить ее значение, при этом работая с неактуальными данными.

### DeadLock

Возникает когда несколько процессов находятся в бесконечном ожидании ресурсов, занятых друг другом и ни один из неихне может продолжить свое выполнение.

### LiveLock

В отличине от DeadLock, система не застревает, а продолжает выполнение совершая бесполезную работу, зацикливается.

### Starvation

Возникает когда общих ресурсов не хватает на все потоки. Когда одни простаивают, в ожидании освобождения ресурсов, другие постоянно выполняют работу с ними.

## Happens before

Пусть есть поток T1 и поток T2 (необязательно отличающийся от потока T1) и действия x и y, выполняемые в потоках T1 и T2 соответственно.
Если x happens-before y, то во время выполнения y треду T2 будут видны все изменения, выполняемые в x тредом T1.

1. Same thread actions  
   Если действие x идет перед y в коде программы и эти действия происходят в одном и том же треде, то x happens-before y.

2. Monitor lock  
   Освобождение монитора happens-before каждый последующий захват того же самого монитора.

3. Volatile  
   Запись в volatile переменную happens-before каждое последующее чтение той же самой переменной.

   ```java
   public final int incrementAndGet() {
         for (;;) {
               int current = get();
               int next = current + 1;
               if (compareAndSet(current, next))
                  return next;
         }
      }
   public final boolean compareAndSet(int expect, int update) {
         return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
      }
   ```

   **CAS** - compare-and-swap. Сравнивает значение в памяти с expect аргументом, и в случае успеха записывающая update в память.

4. Final thread action
   Финальное действие в треде T1 happens-before любое действие в треде T2, которое обнаруживает, что тред T1 завершен.
   Это приводит нас к таким happens-before:  
   4.1. Финальное действие в T1 happens-before завершение вызова T1.join() в T2.  
   4.2. Финальное действие в T1 happens-before завершение вызова T1.isAlive() в T2 (если вызов возвращает false).

5. Default initialization  
   Дефолтная инициализация (0, false или null) при создании переменной happens-before первое действие в каждом треде.
